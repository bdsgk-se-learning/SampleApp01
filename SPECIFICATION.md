# アプリケーション仕様書

## 概要
このアプリケーションは、Flask製のWebアプリケーションで、ユーザー認証機能とユーザー管理機能を備えています。
DAST（Dynamic Application Security Testing）の検証対象として作成されています。

## 機能一覧

### 1. ユーザー認証
- ユーザー登録
  - 通常ユーザーの作成
  - 2FAの有効/無効を選択可能
- ログイン
  - ユーザー名とパスワードによる認証
  - TOTP（2FA）による二段階認証（有効な場合）
- ログアウト
- TOTP（Time-based One-Time Password）による二段階認証
  - SHA-1ハッシュアルゴリズム
  - 6桁の数字コード
  - 30秒の時間ステップ
  - ±30秒の許容範囲

### 2. アカウント管理
- パスワード変更
  - 現在のパスワード確認
  - 新しいパスワードの設定
- 二段階認証の設定
  - QRコードによる簡単設定
  - 手動での設定コード入力
  - 2FAの有効化/無効化
  - Google Authenticator互換

### 3. 管理者機能
- ユーザー管理
  - ユーザー一覧の表示
  - ユーザーのパスワードリセット
  - ユーザーの2FA設定リセット
- 保護されたユーザーの管理
  - 管理者アカウントは保護され、リセット不可

### 4. ページ構成
- ホームページ（/）
  - ログイン済みユーザーのみアクセス可能
  - ユーザー名を表示
  - ナビゲーションメニューを表示
- ユーザー一覧ページ（/users）
  - ログイン済みユーザーのみアクセス可能
  - 登録済みユーザーの一覧を表示
- アカウント設定ページ（/account）
  - パスワード変更
  - 2FA設定の管理
- 管理者用ユーザー管理ページ（/admin/users）
  - 管理者のみアクセス可能
  - ユーザー一覧と管理機能

### 5. データベース構造
#### usersテーブル
| カラム名 | 型 | 説明 |
|---------|------|------|
| id | INTEGER | 主キー |
| username | TEXT | ユーザー名（一意） |
| password | TEXT | パスワード（ハッシュ化） |
| totp_secret | TEXT | TOTP用シークレットキー |
| is_2fa_enabled | BOOLEAN | 2FA有効フラグ |
| is_admin | BOOLEAN | 管理者フラグ |
| is_protected | BOOLEAN | 保護フラグ |

## 技術スタック
- Python/Flask: Webアプリケーションフレームワーク
- SQLite: データベース
- Bootstrap 5.3.0: UIフレームワーク
- Werkzeug: パスワードハッシュ化
- pyotp: TOTP実装
- qrcode: QRコード生成

## セキュリティ機能
- パスワードのハッシュ化（Werkzeug）
- セッション管理
  - HTTPOnly Cookie
  - Secure Cookie（本番環境）
  - SameSite=Lax
  - セッションタイムアウト（30分）
- CSRF保護
  - すべてのフォームでトークン検証
- TOTP二段階認証
  - Google Authenticator互換
  - 標準TOTPパラメータに準拠
- アクセス制御
  - ログイン要求
  - 管理者権限の確認
  - 保護されたユーザーの制限

## 動作環境
- ローカル環境（localhost）での実行
- Python 3.x
- モダンなWebブラウザ